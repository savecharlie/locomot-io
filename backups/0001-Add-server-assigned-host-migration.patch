From e7da4721548fc7800751fcf05925e663bcc8f388 Mon Sep 17 00:00:00 2001
From: ivy <savecharlie@gmail.com>
Date: Thu, 1 Jan 2026 23:02:18 -0700
Subject: [PATCH] Add server-assigned host migration

---
 index.html       | 49 ++++++++++++++++++++++++------------------------
 server/server.ts | 27 ++++++++++++++++++++++++--
 2 files changed, 49 insertions(+), 27 deletions(-)

diff --git a/index.html b/index.html
index 09e63d6..921d6c9 100644
--- a/index.html
+++ b/index.html
@@ -513,6 +513,7 @@
             connected: false,
             playerId: null,
             roomId: null,
+            hostId: null,
             otherPlayers: new Map(), // id -> player state
             playerLastSeen: new Map(), // id -> timestamp for inactive cleanup
             INACTIVE_TIMEOUT: 10000, // Boot players after 10 seconds of no updates
@@ -559,6 +560,10 @@
                     case 'init':
                         this.playerId = data.playerId;
                         console.log('[MP] Assigned ID:', this.playerId);
+                        if (data.hostId) {
+                            this.hostId = data.hostId;
+                            this.isHost = this.playerId === data.hostId;
+                        }
                         // Initialize other players
                         for (const p of data.players) {
                             if (p.id !== this.playerId) {
@@ -566,14 +571,16 @@
                                 this.playerLastSeen.set(p.id, Date.now());
                             }
                         }
-                        // If there are other players, request arena sync from them
-                        if (this.otherPlayers.size > 0) {
+                        if (!data.hostId) {
+                            this.isHost = this.otherPlayers.size === 0;
+                        }
+                        // If we are not host, request arena sync from them
+                        if (!this.isHost && this.otherPlayers.size > 0) {
                             console.log('[MP] Other players exist, requesting arena sync');
-                            this.isHost = false; // We're joining, not hosting
                             this.send({ type: 'request_arena' });
-                        } else {
-                            console.log('[MP] We are first player - becoming HOST');
-                            this.isHost = true; // We're the host
+                        } else if (this.isHost) {
+                            console.log('[MP] We are host');
+                            this.showStatus('You are HOST');
                         }
                         break;
 
@@ -583,7 +590,7 @@
                         this.playerLastSeen.set(data.player.id, Date.now());
                         this.showStatus(`${data.player.name} joined!`);
                         // Send arena state if we have enemies (any game state)
-                        if (enemies.length > 0) {
+                        if (this.isHost && enemies.length > 0) {
                             console.log('[MP] Sending arena to new player');
                             this.sendArenaSync(data.player.id);
                         }
@@ -602,7 +609,7 @@
                     case 'arena_request':
                         // Another player is requesting our arena state
                         console.log('[MP] Arena request from', data.fromId, '- we have', enemies.length, 'enemies');
-                        if (enemies.length > 0) {
+                        if (this.isHost && enemies.length > 0) {
                             console.log('[MP] Responding with arena sync');
                             this.sendArenaSync(data.fromId);
                         }
@@ -624,8 +631,6 @@
                         this.otherPlayers.delete(data.playerId);
                         this.playerLastSeen.delete(data.playerId);
                         if (left) this.showStatus(`${left.name} left`);
-                        // Host migration: if we're not host but no one else exists, become host
-                        this.checkHostMigration();
                         break;
 
                     case 'state':
@@ -658,6 +663,15 @@
                     case 'pickup_collected':
                         this.removePickupById(data.pickupId, data.x, data.y);
                         break;
+
+                    case 'host_assigned':
+                        this.hostId = data.hostId;
+                        const wasHost = this.isHost;
+                        this.isHost = this.playerId === data.hostId;
+                        if (this.isHost && !wasHost) {
+                            this.showStatus('You are now HOST');
+                        }
+                        break;
                 }
             },
 
@@ -952,21 +966,6 @@
                 syncPickupIdCounter(pickups);
             },
 
-            // Deterministic host migration: lowest playerId becomes host
-            checkHostMigration() {
-                if (!this.playerId || !this.connected) return;
-
-                // Collect all player IDs (including self)
-                const allIds = [this.playerId, ...this.otherPlayers.keys()].sort();
-                const shouldBeHost = allIds[0] === this.playerId;
-
-                if (shouldBeHost && !this.isHost) {
-                    console.log('[MP] Host migration: becoming HOST');
-                    this.isHost = true;
-                    this.showStatus('You are now HOST');
-                }
-            },
-
             setUsername(name) {
                 name = name.trim().slice(0, 12) || 'Train' + Math.floor(Math.random() * 999);
                 this.username = name;
diff --git a/server/server.ts b/server/server.ts
index f74f7f0..34680f6 100644
--- a/server/server.ts
+++ b/server/server.ts
@@ -18,6 +18,7 @@ interface GameState {
   players: Map<string, Player>;
   pickups: { x: number; y: number; type: string }[];
   worldSize: { cols: number; rows: number };
+  hostId: string | null;
 }
 
 const COLORS = ['#f0f', '#0ff', '#ff0', '#f80', '#8f0', '#08f', '#f08', '#80f'];
@@ -32,7 +33,8 @@ export default class LocomotServer implements Party.Server {
     this.state = {
       players: new Map(),
       pickups: this.generatePickups(50),
-      worldSize: { cols: WORLD_COLS, rows: WORLD_ROWS }
+      worldSize: { cols: WORLD_COLS, rows: WORLD_ROWS },
+      hostId: null
     };
 
     // Clean up stale players every 10 seconds
@@ -65,6 +67,17 @@ export default class LocomotServer implements Party.Server {
     }
   }
 
+  assignHost(newHostId: string | null) {
+    if (this.state.hostId === newHostId) return;
+    this.state.hostId = newHostId;
+    if (newHostId) {
+      this.room.broadcast(JSON.stringify({
+        type: 'host_assigned',
+        hostId: newHostId
+      }));
+    }
+  }
+
   generatePickups(count: number) {
     const pickups = [];
     for (let i = 0; i < count; i++) {
@@ -118,6 +131,9 @@ export default class LocomotServer implements Party.Server {
     };
 
     this.state.players.set(conn.id, player);
+    if (!this.state.hostId) {
+      this.assignHost(conn.id);
+    }
 
     // Send initial state to new player
     conn.send(JSON.stringify({
@@ -126,7 +142,8 @@ export default class LocomotServer implements Party.Server {
       player,
       players: Array.from(this.state.players.values()),
       pickups: this.state.pickups,
-      worldSize: this.state.worldSize
+      worldSize: this.state.worldSize,
+      hostId: this.state.hostId
     }));
 
     // Notify others of new player
@@ -148,6 +165,12 @@ export default class LocomotServer implements Party.Server {
       playerId: conn.id
     }));
 
+    if (this.state.hostId === conn.id) {
+      const remainingIds = Array.from(this.state.players.keys()).sort();
+      const nextHost = remainingIds.length > 0 ? remainingIds[0] : null;
+      this.assignHost(nextHost);
+    }
+
     console.log(`Player ${conn.id} left. Total: ${this.state.players.size}`);
   }
 
-- 
2.34.1

